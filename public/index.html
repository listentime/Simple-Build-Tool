<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.js"></script>
  <style>
    #app {
      width: 1200px;
      height: 800px;
      overflow: scroll;
      margin: 0 auto;
      background-color: black;
      padding: 20px;
      color: aliceblue;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <!-- 输入项目的路径 -->
  <input type="text" value="/Users/fic/Desktop/my-app" id="dirPath">
  <button id="buildSubmit">构建</button>
  <div id="app">
    <!-- 输出内容的载体 -->
    <div><code id="content" class="content"></code></div>
    <div style="color:#f1ac0c;word-wrap:break-all;"><code id="warning"></code></div>
    <div style="color:red;word-wrap:break-all;"><code id="error"></code></div>
  </div>
  <script>
    let buildSubmit = document.getElementById( 'buildSubmit' )
    let app = document.getElementById( 'content' )
    let dirPath = document.getElementById( 'dirPath' )
    let error = document.getElementById( 'error' )
    let warning = document.getElementById( 'warning' )

    // 通过 new EventSource 开启 SSE
    const source = new EventSource( `http://127.0.0.1:3001/api/log/push` );
    // 监听 message 事件
    source.onmessage = event => {
      app.innerHTML += `${ event.data }</br>`
    }
    source.addEventListener( 'warning', event => {
      warning.innerHTML += `⚠️:${ event.data }</br>`
    }, false )
    source.addEventListener( 'stop', event => {
      app.innerHTML += `${ event.data }</br>`
      source.close()
    }, false )
    source.addEventListener( 'error', event => {
      error.innerHTML += `🙅:${ event.data }</br>`
      source.close()
    }, false )
    buildSubmit.onclick = () => {
      // 构建之前清空载体
      app.innerHTML = '';
      error.innerHTML = '';
      warning.innerHTML = '';
      const projectPath = dirPath.value;
      // 做了个简单校验
      if ( !projectPath ) {
        error.innerHTML += '🙅:目标打包路径不能为空</br>'
        return
      }
      // 发起请求
      $.ajax( {
        url: 'http://127.0.0.1:3001/api/project/build',
        method: 'post',
        data: {
          projectPath // 项目路径
        },
        // 成功回调
        success: res => {
          app.innerHTML += `${ res.msg }</br>`
        }
      } )
    }
  </script>
</body>

</html>